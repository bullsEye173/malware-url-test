package com.cisco.security.load;

import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.elasticsearch.core.ElasticsearchOperations;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import com.cisco.security.jpa.repository.UrlJpaRepository;
import com.cisco.security.model.Url;
import com.cisco.security.model.Url.ThreatType;
import com.cisco.security.repository.UrlRepository;

import javax.annotation.PostConstruct;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;

@Component
public class UrlLoaders {

	private static final org.slf4j.Logger logger = LoggerFactory.getLogger(UrlLoaders.class);

	@Autowired
	ElasticsearchOperations operations;

	@Autowired
	UrlRepository repository;

	@Autowired
	UrlJpaRepository jpaRepository;

	@PostConstruct
	@Transactional
	public void loadAll() {
		operations.putMapping(Url.class);
		logger.info("Loading Data");
		List<Url> data = findAll();
		if (data.isEmpty()) {
			data = prepareData();
			jpaRepository.save(data); // saves to H2 DB
		}
		HashSet<Url> malwareData = prepareMalwareData(); // Get from H2 DB
		repository.save(malwareData); // loads into Elastic
		logger.info("Loading Completed");

	}

	private List<Url> findAll() {
		return jpaRepository.findAll();
	}

	private List<Url> prepareData() {
		List<Url> urls = new ArrayList<>();
		urls.add(new Url("example.com", 0, "path/to/page", "name=ferret&color=purple",
				ThreatType.THREAT_TYPE_UNSPECIFIED));
		urls.add(new Url("cisco.com", 0, "c/en/us/products/index.html", "", ThreatType.THREAT_TYPE_UNSPECIFIED));
		urls.add(new Url("amazon.com", 0, "gp/bestsellers", "ref_=nav_cs_bestsellers",
				ThreatType.THREAT_TYPE_UNSPECIFIED));
		return urls;
	}

	private HashSet<Url> prepareMalwareData() {
		HashSet<Url> malwareUrls = new HashSet<>();
		malwareUrls
				.add(new Url("ama-alliance.com", 8080, "path/to/page", "name=ferret&color=purple", ThreatType.MALWARE));
		malwareUrls.add(new Url("ama-alliance.com", 8080, "about", "", ThreatType.MALWARE));
		malwareUrls.add(new Url("betarg.com", 0, "about", "", ThreatType.MALWARE));
		malwareUrls.add(new Url("pastebin.com", 0, "raw/e4BDs1sM", "", ThreatType.MALWARE));
		malwareUrls.add(new Url("93.114.82.154", 0, "nite.sh", "", ThreatType.MALWARE));
		malwareUrls.add(new Url("belboy.in", 0,
				"development/wp-content/themes/busify/hhixalwxvxs/LoanAgreement_318029801_05122020.zip", "",
				ThreatType.MALWARE));
		malwareUrls.add(
				new Url("productos.opiname.es", 0, "wp-content/dvrdjlp/co/oV/yH2nVbK2.zip", "", ThreatType.MALWARE));
		malwareUrls.add(new Url("111.43.223.83:44462", 0, "Mozi.m", "", ThreatType.MALWARE));
		malwareUrls.add(new Url("45.14.224.204", 0, "yoyobins.sh", "", ThreatType.MALWARE));
		malwareUrls.add(new Url("doodledesign.in", 0,
				"wp-content/themes/danfe/ndjwupte/34109056/LoanAgreement_34109056_05122020.zip", "",
				ThreatType.MALWARE));
		malwareUrls.add(new Url("plivao.com", 0, "wp-content/plugins/apikey/gruhlys/LoanAgreement_9531_05122020.zip",
				"", ThreatType.MALWARE));
		return malwareUrls;
	}
}
